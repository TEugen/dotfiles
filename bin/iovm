#!/usr/bin/env bash

# check if a command exists
is_command() {
  hash $1 2>/dev/null
}


# Parse end return only the semver format
semver() {
  echo $@ | egrep -o '[0-9]*[.][0-9]*[.][0-9]*([0-9A-Za-z-]*)'
}


# Provides a navigable option list
#
# example:
#   list_select "item1 item2 item3" "item2" "do_something"
#
list_select() {
  local items=$1; shift
  local list=($items)
  local length=${#list[@]}
  local selected=$1; shift
  local callback=$@
  local index

  # clear screen
  clear

  # display list
  for (( i = 0; i <= $length; ++i )); do
    local mark=" "

    if [[ ${list[$i]} =~ $selected ]]; then
      mark="❯"
      index=$i
    fi

    echo -e " $mark ${list[$i]}"
  done

  # read key input
  read -s -n 3 key

  case $key in
    $'\033[A') # key up
      index=$([ $index = 0 ] && printf $(($length - 1)) || printf $(($index - 1)))
      list_select "$items" "${list[$index]}" $callback
    ;;

    $'\033[B') # key down
      index=$([ $index = $(($length - 1)) ] && printf 0 || printf $(($index + 1)))
      list_select "$items" "${list[$index]}" $callback
    ;;
    "") # enter
      clear
      $callback $selected
    ;;

    *) clear ;;
  esac
}


###############################################################################


if [ ! -n "$APPS_PATH" ]; then
  echo "APPS_PATH not defined"
  exit 1
fi

IOJS_PATH="$APPS_PATH/io.js"
IOJS_VERSIONS="$IOJS_PATH/versions"
IOJS_URL="https://iojs.org/dist"


get_installed_versions() {
  semver $(ls -d $IOJS_VERSIONS/*) | sort -u -k 1,1n -k 2,2n -k 3,3n -t .
}


get_all_versions() {
  curl -L -s $IOJS_URL/index.tab -o - \
    | command sed 1d \
    | command sed "s/^/iojs-/" \
    | command cut -f1 \
    | command sed "s/^iojs-v//" \
    | command sort
}


get_latest_version() {
  get_all_versions | tail -n 1
}


get_active_version() {
  if is_command "iojs"; then
    semver $(iojs --version)
  else
    echo "io.js not installed"
  fi
}


set_version() {
  local version=$1

  echo "Setting io.js version ..."
  cp -R -f $IOJS_VERSIONS/$version/* "$IOJS_PATH"
  echo "Active io.js version: $(get_active_version)"
}


list() {
  local versions=$(get_installed_versions)
  local active=$(get_active_version)

  list_select "$versions" "$active" "set_version"
}


install() {
  local version="$1"

  case $version in
    latest) version=$(get_latest_version) ;;
  esac

  local dir="$IOJS_VERSIONS/$version"
  local url=$(get_version_url $version)

  # is version installed?
  if [ -d "$dir" ]; then
    echo "io.js $version already installed"
  else
    mkdir -p "$dir" && cd $_

    # download and unarchive source
    curl -L# "$url" | tar -zx --strip 1

    set_version "$version"
  fi
}


# make tarball url for <version>
get_version_url() {
  local version=$1
  local arch="x86"
  local os

  case $OSTYPE in
    darwin*) os=darwin ;;
     linux*) os=linux ;;
  esac

  case $(uname -a) in
    *x86_64*) arch=x64 ;;
    *armv*) arch=armv71 ;;
  esac

  echo "$IOJS_URL/v$version/iojs-v$version-$os-$arch.tar.gz"
}


run() {
  local version="$1"; shift
  local arguments="$@"
  local bin="$IOJS_VERSIONS/$version/bin/iojs"

  if [ -f "$bin" ]; then
    shift;
    $bin $arguments
  else
    echo "io.js $version not installed"
  fi
}


remove() {
  local version=$1

  if [ -z $version ]; then
    local versions=$(get_installed_versions)
    local selected=$(get_installed_versions | head -n 1)

    list_select "$versions" "$selected" remove_version
  else
    remove_version $version
  fi
}

remove_version() {
  rm -rf "$IOJS_VERSIONS/$1" && echo "io.js $1 removed"
}


help() {
  echo "
  Usage: iom <command> <options>

  Commands:
    list               List the installed versions
    install            Install the latest stable release
    install <version>  Install specific version or 'latest'
    remove <version>   Remove specific version
    run <version>      Execute specific version
    help               Display help

  Aliases:
    ls  list
    i   install
    rm  remove
    h   help
"
}


main() {
  local command=$1

  # create folders if not available
  [ -d "$IOJS_VERSIONS" ] || mkdir -p "$IOJS_VERSIONS"

  # parse arguments
  case $command in
        ls|list) list;;
       versions) get_all_versions;;
      i|install) shift; install $@;;
      rm|remove) shift; remove $@;;
            run) shift; run $@;;
    -h|--help|*) help;;
  esac
}


main $@